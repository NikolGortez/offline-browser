<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Offline Browser – Markdown-редактор</title>

  <!-- Подключаем SimpleMDE (для offline-приложения можно забрать эти файлы локально) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #333;
      color: #fff;
      padding: 10px 20px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    #register-container, #login-container {
      max-width: 400px;
      margin: 20px auto;
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    fieldset {
      margin-bottom: 20px;
      padding: 10px;
    }
    legend {
      font-weight: bold;
    }
    .message {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      display: none;
    }
    .error {
      background-color: #fdd;
      border: 1px solid #f99;
      color: #900;
    }
    .success {
      background-color: #dfd;
      border: 1px solid #9f9;
      color: #090;
    }

    /* ======================== ОСНОВНОЙ ЛЕЙАУТ ======================== */
    #app {
      flex: 1;
      display: none; /* скрыт до авторизации */
      height: calc(100vh - 50px);
    }
    #sidebar {
      width: 250px;
      background: #f5f5f5;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #sidebar h2 {
      margin: 10px;
      font-size: 18px;
    }
    #notes-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
    }
    #notes-list li {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    #notes-list li:hover, #notes-list li.active {
      background: #e0e0e0;
    }
    #sidebar-controls {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #editor-header {
      border-bottom: 1px solid #ddd;
      padding: 10px;
      display: flex;
      align-items: center;
      background: #fafafa;
    }
    #editor-header button {
      width: auto;
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 13px;
    }
    #note-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    #note-editor {
      flex: 1;
      /* SimpleMDE сам создаст свой контейнер, так что этот selector можно не использовать */
    }
    #note-message {
      position: absolute;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <!-- ========== ШАПКА ========== -->
  <header>
    <h1>Offline Browser — Markdown-редактор</h1>
  </header>

  <!-- ========== ФОРМА РЕГИСТРАЦИИ ========== -->
  <div id="register-container">
    <fieldset>
      <legend>Регистрация</legend>
      <input id="reg-username" placeholder="Username">
      <input id="reg-password" placeholder="Password" type="password">
      <input id="reg-display_name" placeholder="Display Name">
      <input id="reg-email" placeholder="Email">
      <button id="btn-register">Зарегистрироваться</button>
      <div id="reg-message" class="message"></div>
    </fieldset>
  </div>

  <!-- ========== ФОРМА ВХОДА ========== -->
  <div id="login-container">
    <fieldset>
      <legend>Вход</legend>
      <input id="login-username" placeholder="Username">
      <input id="login-password" placeholder="Password" type="password">
      <button id="btn-login">Войти</button>
      <div id="login-message" class="message"></div>
    </fieldset>
  </div>

  <!-- ================= ОСНОВНОЙ ИНТЕРФЕЙС ПОСЛЕ ВХОДА ================= -->
  <div id="app">
    <!-- ===== ЛЕВАЯ ПАНЕЛЬ: СПИСОК ЗАМЕТОК ===== -->
    <div id="sidebar">
      <div id="sidebar-controls">
        <button id="btn-new-note">+ Новая заметка</button>
      </div>
      <h2>Мои заметки</h2>
      <ul id="notes-list"></ul>
    </div>

    <!-- ===== ПРАВАЯ ПАНЕЛЬ: РЕДАКТОР ===== -->
    <div id="main">
      <div id="editor-header">
        <button id="btn-save-note">Сохранить</button>
        <span id="editor-status"></span>
      </div>
      <!-- Поле для заголовка заметки -->
      <input id="note-title" placeholder="Заголовок заметки" disabled>
      <!-- Будет заменено на SimpleMDE -->
      <textarea id="note-editor" placeholder="Выберите или создайте заметку…" disabled></textarea>
      <div id="note-message" class="message"></div>
    </div>
  </div>

  <script>
    /***************************************
     * ОБЩИЕ ПЕРЕМЕННЫЕ
     ***************************************/
    let token = "";
    let notes = [];              // массив объектов { id, title, content, ... }
    let currentNoteId = null;    // id заметки, выбранной в данный момент
    let simplemde = null;        // экземпляр SimpleMDE

    /***************************************
     * УТИЛИТЫ: ПОКАЗать / СКРЫТЬ СООБЩЕНИЯ
     ***************************************/
    function showMessage(elementId, text, isError) {
      const el = document.getElementById(elementId);
      el.textContent = text;
      el.className = "message " + (isError ? "error" : "success");
      el.style.display = "block";
    }
    function clearMessage(elementId) {
      const el = document.getElementById(elementId);
      el.textContent = "";
      el.style.display = "none";
    }

    /***************************************
     * РЕГИСТРАЦИЯ
     ***************************************/
    async function register() {
      const usernameInput = document.getElementById("reg-username");
      const passwordInput = document.getElementById("reg-password");
      const displayInput = document.getElementById("reg-display_name");
      const emailInput = document.getElementById("reg-email");

      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      const display_name = displayInput.value.trim();
      const email = emailInput.value.trim();

      clearMessage("reg-message");

      if (!username || !password || !display_name || !email) {
        showMessage("reg-message", "❌ Заполните все поля регистрации", true);
        if (!username) {
          usernameInput.focus();
        } else if (!password) {
          passwordInput.focus();
        } else if (!display_name) {
          displayInput.focus();
        } else {
          emailInput.focus();
        }
        return;
      }

      try {
        const res = await fetch("/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, display_name, email })
        });
        const data = await res.json();

        if (res.ok) {
          showMessage("reg-message", "✅ Регистрация успешна! Теперь вы можете войти.", false);
          usernameInput.value = "";
          passwordInput.value = "";
          displayInput.value = "";
          emailInput.value = "";
          usernameInput.focus();
        } else {
          showMessage("reg-message", "❌ Ошибка регистрации: " + data.error, true);
          passwordInput.value = "";
          passwordInput.focus();
        }
      } catch (e) {
        console.error(e);
        showMessage("reg-message", "❌ Сетевая ошибка при регистрации", true);
        passwordInput.value = "";
        passwordInput.focus();
      }
    }

    /***************************************
     * ВХОД
     ***************************************/
    async function login() {
      const usernameInput = document.getElementById("login-username");
      const passwordInput = document.getElementById("login-password");

      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      clearMessage("login-message");

      if (!username || !password) {
        showMessage("login-message", "❌ Введите и username, и password", true);
        if (!username) {
          usernameInput.focus();
        } else {
          passwordInput.focus();
        }
        return;
      }

      try {
        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!res.ok) {
          showMessage("login-message", "❌ Ошибка входа: " + data.error, true);
          passwordInput.value = "";
          passwordInput.focus();
          return;
        }

        // Успешный вход
        token = data.token;
        clearMessage("login-message");
        showMessage("login-message", "✅ Успешный вход!", false);

        // Скрываем формы регистрации/логина, показываем основной блок #app
        document.getElementById("register-container").style.display = "none";
        document.getElementById("login-container").style.display = "none";
        document.getElementById("app").style.display = "flex";

        // Инициализируем SimpleMDE
        initEditor();

        // Загружаем список заметок
        await loadNotes();
      } catch (e) {
        console.error(e);
        showMessage("login-message", "❌ Сетевая ошибка при входе", true);
        passwordInput.value = "";
        passwordInput.focus();
      }
    }

    /***************************************
     * ИНИЦИАЛИЗАЦИЯ SIMPLEMDE
     ***************************************/
    function initEditor() {
      if (simplemde) return; // если уже инициализирован – не делаем дважды

      simplemde = new SimpleMDE({
        element: document.getElementById("note-editor"),
        spellChecker: false,
        placeholder: "Выберите или создайте заметку…"
      });

      // Сначала делаем редактор readonly
      simplemde.codemirror.setOption("readOnly", true);

      // Также блокируем поле заголовка
      document.getElementById("note-title").disabled = true;
    }

    /***************************************
     * ЗАГРУЗКА СПИСКА ЗАМЕТОК (GET /notes)
     ***************************************/
    async function loadNotes() {
      clearMessage("note-message");
      const notesListEl = document.getElementById("notes-list");
      notesListEl.innerHTML = "";

      try {
        const res = await fetch("/notes", {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) {
          const err = await res.json();
          showMessage("note-message", "❌ Не удалось получить заметки: " + err.error, true);
          return;
        }
        notes = await res.json();

        notes.forEach(note => {
          const li = document.createElement("li");
          li.textContent = note.title || "(Без названия)";
          li.dataset.id = note.id;
          li.addEventListener("click", () => selectNote(note.id));
          notesListEl.appendChild(li);
        });
      } catch (e) {
        console.error(e);
        showMessage("note-message", "❌ Сетевая ошибка при получении заметок", true);
      }
    }

    /***************************************
     * ВЫБОР ЗАМЕТКИ И ОТОБРАЖЕНИЕ В РЕДАКТОРЕ
     ***************************************/
    function selectNote(noteId) {
      currentNoteId = noteId;
      const note = notes.find(n => n.id == noteId);
      if (!note) return;

      // Подсвечиваем выбранный элемент в списке
      document.querySelectorAll("#notes-list li").forEach(li => {
        li.classList.toggle("active", li.dataset.id == noteId);
      });

      // Заполняем поле заголовка и содержимое
      const titleInput = document.getElementById("note-title");
      titleInput.value = note.title || "";
      titleInput.disabled = false;

      simplemde.codemirror.setOption("readOnly", false);
      simplemde.value(note.content || "");
      simplemde.codemirror.focus();

      clearMessage("note-message");
    }

    /***************************************
     * СОХРАНЕНИЕ ЗАМЕТКИ: PUT /notes/:id ИЛИ POST /notes
     ***************************************/
   // … (весь остальной код остаётся без изменений, вплоть до определения функции saveNote) …

  /***************************************
   * СОХРАНЕНИЕ ЗАМЕТКИ: подробно логируем ответ
   ***************************************/
  async function saveNote() {
    const titleInput = document.getElementById("note-title");
    const content = simplemde.value();
    clearMessage("note-message");

    // Если currentNoteId установлен – это PUT (обновление)
    if (currentNoteId) {
      try {
        // Логируем перед запросом:
        console.log("→ Сохраняем (PUT) заметку ID=", currentNoteId);
        console.log("   Заголовок:", titleInput.value.trim());
        console.log("   Контент:", content);

        const res = await fetch(`/notes/${currentNoteId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            title: titleInput.value.trim(),
            content: content
          })
        });

        // Логируем статус и тело ответа:
        console.log("← Ответ сервера (PUT) статус:", res.status);
        const text = await res.text();
        console.log("← Ответ тело (PUT):", text);

        if (!res.ok) {
          let err = "Неизвестная ошибка";
          try { err = JSON.parse(text).error; } catch(e){ err = text; }
          showMessage("note-message", "❌ Ошибка сохранения: " + err, true);
          return;
        }
        showMessage("note-message", "✅ Заметка обновлена", false);
        await loadNotes(); // Перезагрузить список

      } catch (e) {
        console.error("Ошибка при запросе PUT /notes/:id:", e);
        showMessage("note-message", "❌ Сетевая ошибка при сохранении заметки", true);
      }

    } else {
      // Иначе — создаём новую заметку (POST)
      if (!titleInput.value.trim() && !content.trim()) {
        showMessage("note-message", "❌ Заметка должна содержать заголовок или контент", true);
        return;
      }
      try {
        console.log("→ Создаём (POST) новую заметку");
        console.log("   Заголовок:", titleInput.value.trim());
        console.log("   Контент:", content);

        const res = await fetch("/notes", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            title: titleInput.value.trim(),
            content: content,
            is_global: false
          })
        });

        console.log("← Ответ сервера (POST) статус:", res.status);
        const text = await res.text();
        console.log("← Ответ тело (POST):", text);

        if (!res.ok) {
          let err = "Неизвестная ошибка";
          try { err = JSON.parse(text).error; } catch(e){ err = text; }
          showMessage("note-message", "❌ Ошибка создания: " + err, true);
          return;
        }
        const newNote = JSON.parse(text);
        showMessage("note-message", "✅ Заметка создана", false);

        // Перезагрузим список и выберем новую заметку:
        await loadNotes();
        selectNote(newNote.id);

      } catch (e) {
        console.error("Ошибка при запросе POST /notes:", e);
        showMessage("note-message", "❌ Сетевая ошибка при создании заметки", true);
      }
    }
  }

  // … (далее весь остальной код: newNote(), loadNotes(), selectNote() и т.д.) …

    /***************************************
     * СОЗДАНИЕ НОВОЙ ЗАМЕТКИ (ОЧИСТКА ФОРМЫ)
     ***************************************/
    function newNote() {
      currentNoteId = null;
      // Снимаем выделение со всех пунктов
      document.querySelectorAll("#notes-list li").forEach(li => {
        li.classList.remove("active");
      });
      // Очищаем заголовок и делаем поле активным
      const titleInput = document.getElementById("note-title");
      titleInput.value = "";
      titleInput.disabled = false;

      // Очищаем SimpleMDE, разблокируем и фокусируем
      simplemde.value("");
      simplemde.codemirror.setOption("readOnly", false);
      simplemde.codemirror.focus();

      clearMessage("note-message");
    }

    /***************************************
     * НАЗНАЧЕНИЕ ОБРАБОТЧИКОВ КНОПОК
     ***************************************/
    document.getElementById("btn-register").addEventListener("click", register);
    document.getElementById("btn-login").addEventListener("click", login);
    document.getElementById("btn-save-note").addEventListener("click", saveNote);
    document.getElementById("btn-new-note").addEventListener("click", newNote);

    /***************************************
     * ЗАГРУЗКА СТРАНИЦЫ
     ***************************************/
    window.addEventListener("DOMContentLoaded", () => {
      // Если уже есть токен (например, после релогина), показываем интерфейс
      if (token) {
        document.getElementById("register-container").style.display = "none";
        document.getElementById("login-container").style.display = "none";
        document.getElementById("app").style.display = "flex";
        initEditor();
        loadNotes();
      }
    });
  </script>
</body>
</html>
